---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(data.table)
library(stringr)
library(pheatmap)
library(tidyverse)
library(UpSetR)
library(ggplot2)
path <- "~/inbox/MN06/gene_counts/unique/"
files <- list.files(path)
files <- files[which(!grepl("summary", files))]

for(i in files) {
  df <- fread(paste0(path, i), data.table = F)
  sample_sra_id <- str_remove_all(sapply(str_split(colnames(df)[ncol(df)], "/"), tail, 1), "_Aligned.sortedByCoord.out.bam")
  colnames(df)[ncol(df)] <- sample_sra_id
  rownames(df) <- df$Geneid
  if(i == files[1]){
    gene_counts <- df
    rownames(gene_counts) <- gene_counts$Geneid
  }else{
    gene_counts <- cbind(gene_counts, df[rownames(gene_counts),sample_sra_id,drop=F])
    
  }
}

gene_lengths <- gene_counts[,"Length"] 
samplesheet <- fread("/Volumes/MyPassport/MN06_PTERV/samplesheet_GSE60996.tab", data.table = F)
samplesheet <- samplesheet %>% 
  filter(sra_id %in% colnames(gene_counts))
gene_counts_mtx <- as.matrix(gene_counts[,samplesheet$sra_id])

tpm <- function(counts,len) {
  x <- counts/len
  return(t(t(x)*1e6/colSums(x)))
}

gene_tpm <- as.data.frame(tpm(gene_counts_mtx, gene_lengths))
pdf("/Volumes/MyPassport/MN06_PTERV/results/plots/boxplot_gallego_etal_linc00662.pdf", width = 4, height = 4)
gene_tpm["LINC00662",] %>% 
  rownames_to_column("gene") %>% 
  pivot_longer(-gene) %>% 
  rename("sra_id" = name) %>% 
  left_join(samplesheet) %>% 
  mutate(species = ifelse(startsWith(sample_name, "C"), "chimp", "human")) %>% 
  ggplot(aes(x=species, y=value, fill=species)) + 
  geom_jitter(width=0.2) +
  geom_boxplot(outliers = F, width=0.2, alpha=0.7) +
  theme_bw() + 
  labs(y="TPM", x="", fill="Species") + scale_fill_manual(values = c("human" = "#4DB3D7", "chimp" = "#6CBC97")) +
  ggtitle("LINC00662 expression in iPSC", subtitle = "Gallego et al., 2015") 

gene_tpm["LINC00662",] %>% 
  rownames_to_column("gene") %>% 
  pivot_longer(-gene) %>% 
  rename("sra_id" = name) %>% 
  left_join(samplesheet) %>% 
  mutate(species = ifelse(startsWith(sample_name, "C"), "chimp", "human")) %>% 
  ggplot(aes(x=sample_name, y=value, fill=species)) + geom_bar(stat="identity") + 
  theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  labs(y="TPM", x="", fill="Species") + scale_fill_manual(values = c("human" = "#4DB3D7", "chimp" = "#6CBC97")) +
  ggtitle("LINC00662 expression in iPSC", subtitle = "Gallego et al., 2015") 

gene_tpm["GAPDH",] %>% 
  rownames_to_column("gene") %>% 
  pivot_longer(-gene) %>% 
  rename("sra_id" = name) %>% 
  left_join(samplesheet) %>% 
  mutate(species = ifelse(startsWith(sample_name, "C"), "chimp", "human")) %>% 
  ggplot(aes(x=species, y=value, fill=species)) + 
  geom_jitter(width=0.2) +
  geom_boxplot(outliers = F, width=0.2, alpha=0.7) +
  theme_bw() + 
  labs(y="TPM", x="", fill="Species") + scale_fill_manual(values = c("human" = "#4DB3D7", "chimp" = "#6CBC97")) +
  ggtitle("GAPDH expression in iPSC", subtitle = "Gallego et al., 2015") 

gene_tpm["GAPDH",] %>% 
  rownames_to_column("gene") %>% 
  pivot_longer(-gene) %>% 
  rename("sra_id" = name) %>% 
  left_join(samplesheet) %>% 
  mutate(species = ifelse(startsWith(sample_name, "C"), "chimp", "human")) %>% 
  ggplot(aes(x=sample_name, y=value, fill=species)) + geom_bar(stat="identity") + 
  theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  labs(y="TPM", x="", fill="Species") + scale_fill_manual(values = c("human" = "#4DB3D7", "chimp" = "#6CBC97")) +
  ggtitle("GAPDH expression in iPSC", subtitle = "Gallego et al., 2015") 
dev.off()
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

